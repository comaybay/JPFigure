@page "/figure/{Id:int}";
@using JPFigure.Extensions;
@using Entities.Enums;
@inject FigureRepository figRepo;
@inject NavigationManager UriHelper
@inject CartRepository cartRepo;
<NavBar></NavBar>
@if (figure != null) {
<div class="product_detail_ctn">
    <div class="left_ctn">
        <div class="sub_image_ctn">
		@foreach (var (img, i) in figure.Images.Select((img,i) => (img, i)))
		{
            <div class="small_image_ctn">
                <img src="@img" @onclick="() => OnclickImg(i)">
            </div>
		}
        </div>
        <div class="main_image_ctn">
            <img style="width:467px; height:679px; object-fit:cover" src="@bigImgageSrc" id="ProductImg">
        </div>
    </div>
    <div class="right_ctn">
        <h1>@figure.ProductName</h1>
			<h4>@String.Format("{0:n0}", figure.Price)₫</h4>
        <div class="row">
            <input @bind-value=@quantity type="number" min="1">
            <button @onclick=@AddToCart class="btn">THÊM VÀO GIỎ</button>
        </div>
        <h3>THÔNG TIN SẢN PHẨM</h3>
        <p>@figure.ProductName</p>
        <p>Nhân vật: @figure.Character.Name</p>
        <p>Series: @figure.Character.Series.Name</p>
        <p>Hãng sản xuất: @figure.Manufacture.Name</p>
        <p>Kích thước: @figure.Height </p>
        <p>Phát hành: @figure.ReleaseDate</p>
			@if (figure.Type == FigureType.Gundam)
			{
					<p>Loại Gundam: @figure.GundamType.GetDisplayText()</p>
			}
			else if (figure.Type == FigureType.ScaleFigure)
			{
				<p>Scale: @figure.Scale.GetDisplayText()</p>
			}
        <div class="info_ctn">          
            <img src="Image/package-box.png">
            <div>
                <span>Sản phẩm chính hãng từ Nhật Bản.</span>
            </div>
        </div>
        <div class="info_ctn">
            <img src="Image/fast.png">
            <div>
                <span>Miễn phí ship với các đơn hàng >1000K.</span>
            </div>
        </div>
        <div class="info_ctn">           
            <img src="Image/call.png">
            <div>
                <span>Vui lòng kiểm tra sản phẩm khi nhận bưu kiện.</span>
            </div>
        </div>
    </div>
</div>
<h1 class="other_product_title">Sản Phẩm Liên Quan</h1>
<div class="other_product_ctn">
    <ul class="products">
        @if (relatedFigures != null) {
		@foreach (var (rfig, i) in relatedFigures.Select((f, i) => (f, i)))
		{
			<li>
				<div class="product_item">
					<div class="product_top">
								<a href="/figure/@rfig.Id" class="product_thumb">
							<img src="@rfig.Images.First()" alt="">
						</a>
						<a href="" class="add_cart">
							<span>Add To Cart</span>
							<img src="Image/cart-white.png">
						</a>
					</div>
					<div class="product_info">
						<div class="product_name_ctn">
							<a href="" class="product_name">@rfig.ProductName</a>
						</div>
						<div class="product_price">@string.Format("{0:n0}", rfig.Price)₫</div>
					</div>
				</div>
			</li>
				}}
    </ul>
</div>
}
<BottomBar></BottomBar>
@code {
	[Parameter]
	public int Id { get; set; }

	[CascadingParameter]
	public Task<AuthenticationState> authenticationStateTask { get; set; }

	private string bigImgageSrc { get; set; }
	private Entities.Figure figure = null;
	private int quantity = 1;
	private List<Entities.Figure> relatedFigures = null;

	protected override async Task OnInitializedAsync()
	{
		figure = await figRepo.GetFigureDetail(Id);
		if (figure == null)
		{
			UriHelper.NavigateTo("/");
		}

		relatedFigures = await figRepo.GetRelatedFigures(figure);
		bigImgageSrc = figure.Images[0];
	}

	protected override async Task OnParametersSetAsync()
	{
		await OnInitializedAsync();
		StateHasChanged();
	}

	protected void OnclickImg(int index){
		bigImgageSrc = figure.Images[index];
	}


	private async void AddToCart()
	{
		var state = await authenticationStateTask;
		var email = state.User.Claims.First(c => c.Type == ClaimTypes.Email).Value;
		await cartRepo.AddToCart(email, figure.Id, quantity);
	}
}
